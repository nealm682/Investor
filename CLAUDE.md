# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **two-stage investment analysis pipeline** that screens stocks for sustained momentum and validates financial health using SEC data:

1. **Stage 1 (Momentum)**: Identifies stocks where 5-year performance > 1-year performance (avoiding speculative bubbles)
2. **Stage 2 (Financial)**: Validates companies are revenue generating, profitable, with strong cash positions

**Tech Stack**: Python 3.7+, Streamlit, Selenium (Yahoo Finance scraping), yfinance, SEC EDGAR APIs, OpenAI

## Essential Commands

### Running the Applications
Both apps must run simultaneously on different ports:

```powershell
# Terminal 1: Momentum Analysis UI
streamlit run earnings_ui_filter.py

# Terminal 2: Financial Health Validator
streamlit run financials.py --server.port 8502
```

App URLs:
- Momentum: http://localhost:8501
- Financial: http://localhost:8502

### Development Setup
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1  # Windows PowerShell
pip install -r requirements.txt
```

### Environment Configuration
Create [.env](.env.example) file with:
```
SEC_USER_EMAIL=your-email@domain.com     # Required for SEC EDGAR API
OPENAI_API_KEY=your-openai-api-key      # Optional, enables AI insights
```

## Architecture & Data Flow

### Application Architecture

**Three Python files, two Streamlit apps:**

1. [earnings_ui_filter.py](earnings_ui_filter.py) (448 lines) - Streamlit UI for date selection/filtering
2. [earnings.py](earnings.py) (604 lines) - Core momentum screening logic (called by earnings_ui_filter.py)
3. [financials.py](financials.py) (1891 lines) - SEC financial validation app

### Data Flow
```
earnings_ui_filter.py → earnings.py → CSV export
                                        ↓
                              CSV import → financials.py → Analysis results
```

**CSV Requirements:**
- Must contain `Momentum Filter ✓` column (boolean)
- Generated by earnings.py with filtered winners where 5Y > 1Y performance
- financials.py filters for `df['Momentum Filter ✓'] == True`

### Core Components

**earnings.py:**
- Selenium scrapes Yahoo Finance earnings calendar (requires Chrome browser)
- yfinance fetches historical price data (1Y and 5Y performance)
- Implements momentum filter: `five_year_change > one_year_change`
- Supports multi-date processing with session state management

**financials.py:**
- SEC EDGAR API integration for XBRL financial data
- Analyzes: Revenue, Net Income, Cash, Debt
- OpenAI integration for investment risk analysis
- Generates quarterly trend analysis (6 months)

## Critical Patterns & Bug Fixes

### SEC EDGAR API Requirements

**User-Agent Header (MANDATORY):**
```python
SEC_HEADERS = {
    'User-Agent': 'Individual Investor-Tools/1.0 (your-email@domain.com)'
}
```
- 403 Forbidden errors = incorrect User-Agent format
- Must include organization name and contact email

**Rate Limiting:**
- Maximum 10 requests/second (enforced by SEC)
- Use `rate_limit()` function with global `last_request_time` tracker
- Analysis intentionally slow to comply

**Key Endpoints:**
- Company tickers: `https://www.sec.gov/files/company_tickers.json`
- Company facts: `https://data.sec.gov/api/xbrl/companyfacts/CIK{cik:010d}.json`
- Submissions: `https://data.sec.gov/submissions/CIK{cik:010d}.json`

### XBRL Data Extraction (CRITICAL BUG PATTERNS)

⚠️ **These bugs have caused incorrect financial data in production** ⚠️

#### Bug #1: Old Data Selection
**Problem:** Companies showing 2018-2022 data instead of current 2025 quarters

**Root Cause:** Code breaks after first matching XBRL concept, which may contain old data

**Example:** MP Materials showed 2022-06-30 revenue instead of 2025-09-30

**Solution:** Check ALL concept variations, compare end dates, select most recent
```python
# WRONG - Stops at first concept
for concept in concept_list:
    if concept in us_gaap:
        # Extract data
        break  # ❌ BUG: May have old data

# CORRECT - Checks all concepts
best_date = ''
best_metric = None
for concept in concept_list:
    if concept in us_gaap:
        # Extract data and get end date
        if candidate_date > best_date:
            best_date = candidate_date
            best_metric = data
# Use best_metric after checking all
```

#### Bug #2: Period Misclassification
**Problem:** 9-month cumulative revenue ($986M) displayed as quarterly revenue instead of single quarter ($376M)

**Root Cause:** Using form type (10-Q) to classify periods, but 10-Q can contain year-to-date cumulative data

**Example:** SOFI Q3 showing 9-month cumulative instead of 3-month quarter

**Solution:** Calculate period length from start/end dates using STRICT day ranges
```python
# WRONG - Form-based classification
if '10-Q' in form or (60 <= period_days <= 120):
    quarterly_values.append(v)  # ❌ Includes 9-month periods

# CORRECT - Strict day-count only
if 60 <= period_days <= 120:  # Single quarter only
    quarterly_values.append(v)
elif period_days >= 300:  # Annual only
    annual_values.append(v)
# Never use form type (10-Q, 10-K) for classification
```

#### Bug #3: Debt vs Liabilities Confusion
**Problem:** Companies showing $1.4B debt when they have $0 traditional borrowings

**Root Cause:** Including 'Liabilities' as fallback captures operating leases, deferred revenue

**Example:** PLTR showing total liabilities as debt instead of $0 (debt-free company)

**Solution:** Use specific debt concepts only
```python
# WRONG - Too broad
'TotalDebt': ['DebtAndCapitalLeaseObligations', 'Liabilities']

# CORRECT - Specific debt concepts only
'TotalDebt': [
    'DebtAndCapitalLeaseObligations',
    'DebtLongtermAndShorttermCombinedAmount',
    'LongTermDebt'
]

# Handle debt-free companies explicitly
if no_debt_found:
    return "$0 (No traditional debt reported)"
```

#### Bug #4: File Pointer Exhaustion
**Problem:** CSV upload fails with "empty or has no columns" error

**Root Cause:** Reading uploaded file twice exhausts file pointer

**Solution:** Add `uploaded_file.seek(0)` after each read to reset pointer

### XBRL Concept Variations

The same financial metric has multiple XBRL concept names. MUST check all variations:

**Revenue concepts:**
- `Revenues`
- `RevenueFromContractWithCustomerExcludingAssessedTax`
- `SalesRevenueNet`
- `RevenueFromContractWithCustomerIncludingAssessedTax`

**Net Income concepts:**
- `NetIncomeLoss`
- `ProfitLoss`
- `NetIncomeLossAvailableToCommonStockholdersBasic`

**Cash concepts:**
- `CashAndCashEquivalentsAtCarryingValue`
- `Cash`
- `CashCashEquivalentsAndShortTermInvestments`

**Debt concepts (use specific debt only, NOT total liabilities):**
- `DebtAndCapitalLeaseObligations`
- `DebtLongtermAndShorttermCombinedAmount`
- `LongTermDebt`

### Validated Test Companies

These companies have been used to validate bug fixes:
- **SOFI**: Fixed 9-month vs quarterly classification
- **MP Materials**: Fixed old data selection (2025 not 2022)
- **PLTR**: Fixed debt classification ($0 debt, not $1.4B liabilities)
- **LEU**: Fixed quarterly trends date selection
- **ASTR**: Under audit - investigating conflicting debt values

## Data Processing Patterns

### Period Classification
- **Point-in-Time**: Balance sheet items (Cash, Debt) - use most recent date
- **Period Data**: Income statement (Revenue, Net Income) - classify by period length
  - Quarterly: 60-120 days
  - Annual: 300+ days
  - NEVER use form type (10-Q/10-K) alone for classification

### Momentum Filter Logic
```python
# Core investment philosophy: Avoid momentum traps
if one_year_change is not None and five_year_change is not None:
    passes_momentum_filter = five_year_change > one_year_change
```

### Multi-Date Processing
- Session state: `st.session_state.earnings_dates` for date picker
- Three modes: Single Date, Date Range, Multiple Specific Dates
- Business day validation (warn about weekends)
- Aggregate unique tickers across all dates

## Common Development Issues

### Selenium/Chrome Issues
- Requires Chrome browser installed
- ChromeDriver managed automatically by webdriver-manager
- Remove `--headless` flag to debug browser actions
- Yahoo Finance page structure changes cause TimeoutException

### yfinance Data Quality
- Can be unreliable (handle exceptions)
- Returns MultiIndex columns for price data
- Always check for empty DataFrames
- Fallback: Manual entry or alternative data source

### SEC API Common Errors
1. **403 Forbidden**: Check User-Agent header format
2. **Rate Limit**: Don't interrupt analysis, reduce company count
3. **Missing Data**: Not all companies report standardized XBRL
4. **CIK Lookup Fails**: Use manual ticker entry fallback

### Memory & Performance
- Large date ranges generate thousands of tickers
- Implement progress bars for user feedback
- Limit detailed charts to top 10 companies
- CSV caching with `@st.cache_data(ttl=3600)`

## OpenAI Integration

When `OPENAI_API_KEY` is configured, financials.py provides:
- Investment risk analysis (debt concerns, burn rate)
- Data quality assessment (missing metrics, XBRL limitations)
- Retirement suitability evaluation (conservative risk assessment)
- 200-word max, plain English, risk-first approach

## File Organization

### CSV Naming Convention
- Pattern: `{type}_{date_range}.csv`
- Examples: `filtered_winners_2024-11-14.csv`, `all_winners_2024-11-10_to_2024-11-15.csv`

### Configuration Constants
- `SEC_HEADERS`: User-Agent for EDGAR compliance
- Rate limiting: Global `last_request_time`
- Caching: `@st.cache_data(ttl=3600)` for SEC ticker database

## Important Notes

- **Never** skip the XBRL concept iteration loop - must check all concepts
- **Never** use form type (10-Q, 10-K) alone to classify quarterly vs annual
- **Never** include total liabilities in debt calculations
- **Always** reset file pointers with `seek(0)` after reading uploads
- **Always** use proper SEC User-Agent header with contact email
- **Always** implement rate limiting for SEC API calls (10 req/sec max)
